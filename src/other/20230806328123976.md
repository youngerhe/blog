---
title: 合约计算公式
category:
  - 杂七杂八
date: 2023-08-06
tag:
  - 杂七杂八
  - 公式
---

### **资产**

**账户权益 = 钱包余额+未实现盈亏**

**钱包余额 = 总转入-总转出+已实现盈亏（总转入包括赠金发放，总转出包括赠金回收）**

**已实现盈亏 = 总平仓盈亏 + 总手续费 + 总资金费**

**仓位保证金 = 所有逐仓的仓位保证金之和+所有全仓仓位保证金之和**

**委托保证金 = 所有订单的委托成本之和**

**占用保证金 = 仓位保证金+委托保证金**

**可用保证金 = max（0，钱包余额 - 占用保证金 + min（0，全仓总未实现盈亏））**

**可划转保证金 = max（0，可用保证金-体验金余额）**

**最高买价：指数价\*（1+限价比例）**

**最低卖价：指数价\*（1-限价比例）**

### **订单**

**市价开仓预估价格**

- **市价开多预估成交价格 =最⾼买⼊价（取价格范围的最⼤值）**
- **市价开空预估成交价格=Max (买⼀盘⼝价格, 最低卖出价)（最低卖出价取价格范围的最⼩值）**

**限价开仓预估价格**

- **限价开多预估成交价格 = 委托价格**
- **限价开空预估成交价格 = Max (买⼀盘⼝价格, 限价委托价格)**

**开仓委托价值**

- **开仓委托价值=开仓预估价格 \***开仓张数\*合约⾯值

**开仓预估保证⾦**

- **开仓预估保证⾦ = 开仓委托价值 / 杠杆**

**初始保证⾦率**

- **初始保证⾦率=1/杠杆倍数**

**开仓预估⼿续费**

- **市价/限价（GTC、IOC、FOK）开仓预估⼿续费=开仓委托价值\*Taker 费率**

**委托成本 （需要把平仓部分也包含进去）**

- **委托成本=开仓预估保证⾦+2\*开仓预估⼿续费**

### **仓位**

**开仓保证⾦/初始保证金 （需要把平仓部分也包含进去）**

- **开仓保证⾦/初始保证金=⾯值\***开仓张数*开仓均价*（1/杠杆倍数+taker 费率）

**开仓均价**

- **开仓均价=（|原仓位张数|\***⾯值*原开仓均价+|新开仓张数|*⾯值*新开仓成交均价）/|新仓位张数|*⾯值

**注意：仅适⽤于加仓，减仓不影响开仓均价**

**未实现盈亏**

- **多仓未实现盈亏=（标记价格-开仓均价）\***⾯值\*持仓张数
- **空仓未实现盈亏=（开仓均价-标记价格）\***⾯值\*持仓张数

**未实现盈亏收益率/平仓收益率 （需要改为按照初始保证金）**

- **未实现盈亏收益率 = 未实现盈亏/初始保证金\***100%=未实现盈亏/（⾯值*开仓张数*开仓均价*（1/杠杆倍数+taker 费率））*100%

**平仓盈亏 **

- **多仓平仓盈亏=（平仓均价-开仓均价）\***⾯值\*平仓张数
- **空仓平仓盈亏=（开仓均价-平仓均价）\***⾯值\*平仓张数

**注意：平仓均价是指平仓订单成交均价**

**已实现盈亏 **

- **已实现盈亏=平仓盈亏+资金费+手续费**

**已实现盈亏收益率**

- **已实现盈亏收益率=仓位已实现盈亏总和/平仓保证⾦总和\*100%**

**逐仓保证⾦率**

- **保证⾦率 =(⾯值 _ 持仓张数_ 标记价格 \* (维持保证⾦率+ taker ⼿续费率)) /max(0.00000001, (逐仓仓位保证⾦余额 + 未实现盈亏) ）**

**维持保证⾦（即维持仓位所需的最少保证⾦）：**

- **维持保证⾦ = ⾯值 _ 持仓张数 _ 维持保证⾦率 \* 标记价格**

**维持保证⾦率**

- **维持保证⾦率每个合约在后台配置**

**平仓保证⾦=平仓数量\*开仓均价/杠杆倍数**

**平仓释放保证⾦**

- **逐仓保证⾦释放 = 平仓张数 / 平仓前的总持仓张数 \* 逐仓保证⾦余额（先释放，然后再从释放出去的保证金部分把平仓手续费和平仓盈亏扣减掉）**

**逐仓强平价**

- **多仓预估强平价 = (逐仓保证⾦余额 - ⾯值 \***持仓张数* 开仓均价) / (⾯值 * 持仓张数\* (维持保证⾦率 + taker ⼿续费率 - 1)) ；
- **空仓预估强平价 = (逐仓保证⾦余额 + ⾯值 \***持仓张数* 开仓均价) / (⾯值 *持仓张数\* (维持保证⾦率 + taker ⼿续费率 + 1))；

```
强平公式来源：` `以多仓为例，当⽤⼾仓位发⽣强平时，保证⾦率降低⾄``100``%，即保证⾦余额 - 亏损 = 维持所需保证⾦+⼿续费；` `其中强平时的仓位数据情况：` ` ``仓位保证⾦余额即⽤⼾仓位中的保证⾦``亏损 = （开仓均价-强平价格）*⾯值*张数``维持保证⾦ = 强平价格*⾯值*张数*维持保证⾦率``平仓⼿续费 = 强平价格*⾯值*张数*taker⼿续费率` `整理公式为：` `保证⾦余额 = 维持保证⾦+⼿续费+亏损` `保证⾦余额 = 强平价格*⾯值*张数*维持保证⾦率 + 强平价格*⾯值*张数*taker⼿续费率 + （开仓均价-强平价格）*⾯值*张数` `= 强平价格*⾯值*张数（维持保证⾦率+taker⼿续费率）+开仓均价*⾯值*张数 - 强平价格*⾯值*张数` `= 强平价格*⾯值*张数[（维持保证⾦率+taker⼿续费率）-``1` `] + 开仓均价*⾯值*张数` `整理公式为：` `保证⾦余额 - 开仓均价*⾯值*张数 = 强平价格*⾯值*张数[（维持保证⾦率+taker⼿续费率）-``1` `]` `即多仓强平价格：` `强平价格= (保证⾦余额 - 开仓均价*⾯值*张数）/ [*⾯值*张数[（维持保证⾦率+taker⼿续费率）-``1` `]
```

**逐仓仓位破产价格**

- **多仓破产价格=（开仓均价-逐仓保证⾦余额 / ⾯值/持仓张数）/（1- Taker 费率）**
- **空仓破产价格=（开仓均价+逐仓保证⾦余额 /⾯值/持仓张数 ）/（1+ Taker 费率）**

```
破产价格公式来源：` `以多仓为例，破产价格即为当标记价格达到此价格时，逐仓保证⾦余额+未实现盈亏-平仓⼿续费=``0` `其中强平时的仓位数据情况：` `• 仓位保证⾦余额即⽤⼾仓位中的保证⾦` `• 未实现盈亏 = （破产价格-开仓均价）*⾯值*张数` `• 平仓⼿续费 = 破产价格*⾯值*张数*taker⼿续费率` `整理公式为：` `逐仓保证⾦余额+未实现盈亏-平仓⼿续费=``0` `逐仓保证⾦余额+（破产价格-开仓均价）*⾯值*张数-破产价格*⾯值*张数*taker⼿续费率=``0` `逐仓保证⾦余额+破产价格*⾯值*张数-开仓均价*⾯值*张数-破产价格*⾯值*张数*taker⼿续费率=``0` `逐仓保证⾦余额-开仓均价*⾯值*张数+破产价格*⾯值*张数*（``1``-taker⼿续费率）=``0` `破产价格*⾯值*张数*（``1``-taker⼿续费率）=开仓均价*⾯值*张数-逐仓保证⾦余额` `破产价格=（开仓均价*⾯值*张数-逐仓保证⾦余额）/（⾯值*张数*（``1``-taker⼿续费率））` `破产价格=（开仓均价-逐仓保证⾦余额/⾯值/张数）/（``1``-taker⼿续费率）
```

**全仓：**

**保证金比率=（sum（所有全仓仓位维持保证金）+ sum（所有全仓仓位强平手续费））/max(0.00000001,（钱包余额-逐仓仓位保证金-委托保证金+所有全仓仓位未实现盈亏）)**

**（推算过程：总维持保证金+所有全仓仓位强平手续费>=全仓可用保证金+所有全仓仓位未实现盈亏，其中【全仓可用保证金】=钱包余额-逐仓仓位保证金-委托保证金）。**

**维持保证金 = 标记价格\***持仓数量*合约面值*维持保证金率，所以【所有全仓仓位维持保证金】=A 仓位维持保证金+B 仓位维持保证金+…

**强平价格（全仓）**

**强平价格=（空仓开仓均价\***空仓持仓数量*合约面值-多仓开仓均价*多仓持仓数量*合约面值+钱包余额-逐仓仓位保证金-委托保证金+其他合约全仓仓位未实现盈亏-其他合约全仓仓位强平手续费-其他全仓仓位维持保证金）/（面值*（多仓持仓数量*维持保证金率+空仓持仓数量*维持保证金率-多仓持仓数量+空仓持仓数量+空仓持仓数量*taker 费率+多仓持仓数量*taker 费率））

**（推算过程：所有全仓仓位维持保证金 = 全仓可用保证金+其他合约全仓仓位未实现盈亏-其他合约全仓仓位强平手续费+当前合约未实现盈亏-当前合约强平手续费，然后由当前合约未实现盈亏和强平手续费反推出强平价格。）**

**注：**
**1、其他合约全仓仓位未实现盈亏、其他合约全仓仓位强平手续费，都是按照当时的标记价格计算。**
**2、多仓价格可能为负，我们用"0"表示，空仓价格可能会很大用"1000000"表示 ；**

**破产价格（全仓）**

**破产价格 =（强平时标记价格\***空仓持仓量*面值-强平时标记价格*多仓持仓量*面值 +（钱包余额-逐仓仓位保证金-委托保证金+所有全仓仓位未实现盈亏）*当前合约仓位维持保证金/sum（所有合约全仓仓位维持保证金））/（面值*（空仓持仓量-多仓持仓量+ 多仓持仓量*taker 费率+空仓持仓量\*taker 费率））

**（推算过程：根据强平时剩下的保证金按照维持保证金比例进行分配，然后再根据分配到的保证金 = 当前合约从强平时市场最新价到破产价之间的未实现盈亏+破产价手续费，算出破产价格。）**

**即：（钱包余额-逐仓仓位保证金-委托保证金+所有全仓仓位未实现盈亏）\*当前全仓仓位维持保证金/sum（所有合约全仓仓位维持保证金）+ 当前合约从当前标记价到破产价格的未实现盈亏-当前合约的破产价强平手续费=0**

**注：**

**1、其他合约全仓仓位未实现盈亏，是按照当时的标记价格计算。当前合约仓位维持保证金，是使用强平时标记价格计算的。**
**2、多仓价格可能为负，我们用"0"表示，空仓价格可能会很大用"1000000"表示 **

**减⼩杠杆需增加保证⾦公式（调大杠杆不释放保证金）**

**=Max{0，（⾯值* 张数***开仓均价\*（1/新杠杆倍数+taker 费率）-逐仓仓位保证⾦余额） }

**仓位可减少保证⾦公式**

**=Max{0，（逐仓仓位保证⾦余额+MIN{0，未实现盈亏} -⾯值\***张数*开仓均价*（1/杠杆倍数+taker 费率）） }

**平仓均价**

**平仓均价 = ( 合约⾯值 _ 成交价格 1 的合约数 _ 成交价格 1 + 合约⾯值 _ 成交价格 2 的合约数 _ 成交价格 2 + ... )/（合约⾯值\*总持仓张数）**
